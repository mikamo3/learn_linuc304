# DRBDおよびcLVM

## DRBDとは？

Distributed Replicated Block Device

ブロックデバイスのミラーリング機能を提供

ネットワークを使用したRAID1みたいな感じ

カーネルモジュールとして提供されている

ファイルシステムの制約はないがジャーナルファイルシステム推奨

カーネルモジュールはdrbd

低レベルデバイスとして物理ハードディスク、LVM、EMVSボリュームが使用可能

### DRBDのリソースとロール

データの属性をリソースと呼ぶ

構成要素は

* リソース名
* ボリューム
* DRBDデバイス
* コネクション

リソースはプライマリ、セカンダリのいずれかのロールを持つ

以下のモードで実行する

* 単一プライマリモード
* デュアルプライマリモード

デフォルトでは1台のノードのみがプライマリロールをもつ

プライマリロールのDRBDデバイスでは読み書きの制約なし

セカンダリロールのDRBDデバイスでは対応するプライマリノードからのデータ更新のみを受け付ける。自ノードのアプリケーションからのデータの読み書きは一切できない

切り替えは手動、クラスタ管理アプリケーションによる自動切り替えに対応

デュアルプライマリモードではすべてのリソースが任意の時点でプライマリロールを持つ

2つのノードから同一データに対して同時アクセスが可能。

そのためGFS2やOCFS2のような分散ロックマネージャを持つ分散クラスタファイルシステムが必須

### リソースのステータス情報

```
/proc/drbd
```

という仮想ファイルシステムに書き込まれる

### PacemakerクラスタでのDRBDの使用

以下のリソースを設定、管理する必要あり

* レプリケーションリソース（クラスタサービス）
* クラスタサービスにたいする仮想IPアドレス
* DRBDストレージをマウントするためのファイルシステムリソース

### レプリケーションモード

通信において同期、非同期に対応していて以下のレプリケーションモードで動作可能

* プロトコルA　非同期　障害耐性低い、レイテンシ高い
* プロトコルB　メモリ同期（半非同期）耐障害性中、レイテンシ中
* プロトコルC　動機レプリケーション　耐障害性高い、レイテンシ長い

AではTCP送信バッファに送られた時点で書き込み完了とする
Bではセカンダリノードに届いた時点で書き込み完了としている
Cではセカンダリノードのディスクに書き込まれた時点で完了としている

### 3ノードレプリケーション

冗長性を高めるために3番目のノードを追加できる

用途は主にバックアップやディザスタリカバリ

プロトコルCだとネットワーク遅延によりレイテンシが遅くなる可能性があるのでAを利用するなどする

### DRBDのデュアルプライマリモードによる負荷分散

```
/etc/drbd.conf
```

という設定ファイルに

resource > netセクションで

```
allow-two-primaries
```
オプションを設定してデュアルプライマリモードにする

## DRBDの管理用ユーティリティ

* drbdadm debdsetup,debdmetaのフロントエンド
* drbdsetup drbdモジュールの設定
* drbdmeta DRBDメタデータの作成や変更、ダンプ、リストアを行う

### drbdadm

drbdadm オプション サブコマンド 引数


コマンド例

* role 両ノードのデバイスの現在のロールを表示
* cstate 両ノードのデバイスの接続状態を表示
* verify オンライン照合を実行

DRBDのリソースを有効にするには以下のとおり実行

```
drbdadm attach リソース名
drbdadm syncer リソース名
drbdadm connect リソース名
```

## cLVMとは？

Clusterd Logical Volume Manager

LVMのクラスタ用拡張

クラスタ内の各ノードでclvmdデーモンが動作してすべてのノードで利用可能な共有ストレージ上で動作

## cLVMユーティリティ

### vgsコマンド

ボリュームグループ一覧を表示

### vgchangeコマンド

ボリュームグループの属性を変更する

例：ボリュームグループを共有するかは

```
vgchange -c [yn]
```

