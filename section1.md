# 1-1 仮想化の概念と理論
## 仮想化とは？
## 仮想化のメリットとデメリット

### メリット

物理的スペースの削減
物理的サーバの運用コストの削減

### デメリット

性能劣化

障害原因の特定の難化

学習コスト

特有のセキュリティ問題

アプリの動作検証

## 仮想化方式の種類
### ホストOS型

物理亭なハードウェア上のOSにインストールしてその上で動かす

* VMware
* VirtualPC
* VirtualBox

### ハイパーバイザー型

ホストOS不要

ハイパーバイザーというソフトを物理ハードウェア上で動かしてその上で仮想マシンを動かす

ホストOS型よりパフォーマンスが高い

* VMwreESXi
* Xen
* Hyper-V

### コンテナ型

ホストOS型の一種として分類

コンテナにはゲストOSや仮想ハードウェアは含まれない

ホストOSにインストールされたLinuxカーネルが同じであれば別のディストリビューションを動かせる

ホストと異なるOSは利用できない

高パフォーマンス、低リソース、構成管理が容易

* OpenVZ
* LXC
* Docker

### 仮想マシンの移行(マイグレーション)

P2V 物理サーバから仮想サーバへ移行
V2V 仮想サーバから仮想サーバ

### 準仮想化と完全仮想化

ハイパーバイザー型において

準仮想化 ゲストOSに修正が必要、ゲストOSのシステムコールをハイパーバイザーが処理する（ハイパーバイザーコール）。ハイパーバイザーコールに置き換えるための修正

nonプロプライエタリなOS向け

デバイスドライバはゲストOSにインストールされる

完全仮想化 ゲストOSの修正不要、プロプライエタリOS向け。パフォーマンスは落ちる。仮想ハードウェアによるハードウェアエミュレーションが行われる

### CPUモードと特権モード

CPUモード 特権モードとユーザーモードに分類,デバイスドライバやOS

特権モード　CPUが備える機能をすべて利用可能,アプリケーション

ユーザモード　制限あり

ゲストOSはアプリケーションのため特権CPU命令を実行できないため解決策として

* バイナリトランスレーション
* CPU仮想化支援機能

がある。

### CPUの仮想化支援機能とCPUフラグ

CPUの仮想化支援機能

ハードウェアレベルの仮想化支援技術

* Intel VT
* AMD-V

CPUフラグ

CPUのサポートしている機能を表すフラグ

```
/proc/cpuinfo
```
に

vmx (intel)

svm(amd)

があれば仮想化支援機能が使える

### クラウドコンピューティング

インターネットを通じて物理リソースやソフトを含めたコンピューティング全体を利用、提供するアーキテクチャ

### クラウドコンピューティングのサービスモデル

* SaaS
* PaaS
* IaaS

# 1-2 Xen

## Xenとは？

ハイパバイザー型

## Xenの基本的なアーキテクチャ

ドメイン 仮想OSの実行単位

Domain-0 (dom0) 管理用OSを実行するドメイン
Domain-U (domU) ゲストOSを実行するドメイン

ゲストOSからのハイパーバイザーコールはXenがうけとり、Dom0の仮想デバイスとデバイスドライバを介して物理ハードを制御する

Xenハイパーバイザーにはデバイスドライバは含まれない

domUではストレージドライバが不要、アクセス可能なのはdom0がマウントしたファイルシステムのイメージファイル、iSCSI,NBD

ゲストは準仮想化、完全仮想化をサポート

完全仮想化ゲストをHVMドメインと呼ぶ

## Xenの設定

domUの設定ファイルは

```
/etc/xen/ドメイン名
```

完全仮想化度名動かす場合

```
builder='hvm'
```

と設定する

自動起動は

```
/etc/xen/auto
```

にシンボリックリンクをはってxendomainsサービスを自動起動するようにする

メモリ容量はブートローダの設定に

```
dom0_mem=512M
```

などとする

domUのネットワークには仮想NICが作成される。dom0の仮想NICに紐付けされる。

ブリッジ、ルーティング、NATのモードがサポートされる

ブリッジ　ドメインを物理ホストと同じ物理ネットワークに接続したい場合に使う

閉じたネットワークはNAT,ルーティングモードを使う

## Xenのユーティリティとツールスタック

LibXenlightが共通ライブラリ

XL,XAPI,XE,Libvirt,virshがフロントエンドツール

xentop,xenstore-lsなど

完全、準どちらも同じツールを使う

XENDは削除

### xlコマンド

Xen管理のデフォルトのツール,4.1以降,3のxmコマンドの拡張

主なコマンド

* xl shutdown
* xl destroy
* xl block-list あタッチされているブロックデバイスの表示
* xl create -c domain1 設定ファイルを指定してコンソールを現在のコマンドラインで開く
* xl list

xl listのstateの意味

* b blocked
* c crashed
* d dying
* p paused
* r running
* s shutdown

設定ファイルの位置は

```
/etc/xen/xl.comf
```

### XAPI/XE

デフォルトの管理ツールとインターフェースを提供

通常のツールスタックに追加して色々機能追加

XAPIはxeコマンドを使用して操作

### xentop

リソース情報をリアルタイム表示

### xenstore

Xenドメインに関する実行時情報を階層的に格納するデータベース

dom0のxenstoredによって管理

情報はXenのドメイン間で共有される

情報はxenstore-lsで取得できる








